name: Publish Release

on:
  # Listen for the version-merged event from version-management workflow
  repository_dispatch:
    types: [version-merged]

concurrency:
  group: publish-${{ github.event.client_payload.data.version }}
  cancel-in-progress: false

jobs:
  publish:
    name: Publish to NPM & Create Release
    uses: NextNodeSolutions/github-actions/.github/workflows/publish-release.yml@main
    with:
      node-version: '20'
      pnpm-version: '10.11.0'
      publish-script: 'changeset:publish'
      build-script: 'build'
      enable-provenance: true
      # Event data from repository_dispatch
      version: ${{ github.event.client_payload.data.version }}
      pr-number: ${{ github.event.client_payload.data.pr_number }}
      merge-commit-sha: ${{ github.event.client_payload.data.merge_commit_sha }}
    secrets:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
